<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MultiChain CNS Mapper</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
        h1, h2 { text-align: center; color: #333; }
        button { background-color: #007BFF; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        input { padding: 6px; border: 1px solid #ccc; border-radius: 5px; margin-right: 10px; }
        #cnsContainer { margin: 20px auto; width: 80%; }
    </style>
</head>
<body>
    <h1>MultiChain CNS Mapper</h1>
    <div style="text-align: center;">
        <button id="connectBtn">Connect Wallet</button>
        <p id="walletAddressDisplay">Wallet not connected</p>
    </div>

    <h2>Add CNS Name</h2>
    <div style="text-align: center;">
        <input type="text" id="newCnsName" placeholder="Enter CNS Name">
        <button id="addCnsBtn">Add CNS Name</button>
    </div>

    <h2>Your CNS Names</h2>
    <div id="cnsContainer">Click 'Connect Wallet' to load CNS names.</div>

    <script type="module">
    import { connectWallet } from './connectWallet.js';
    import { fetchUserCNS } from './fetchUserCNS.js';
    import { uploadToIPFS } from './uploadToIPFS.js';
    import { getDynamicFee } from './getDynamicFee.js';
    import { updateCNSOnBlockchain } from './updateCNSOnBlockchain.js';
    import { renderCNS } from './renderCNS.js';
    import { toggleAddress } from './addAddress.js';

    let contract, userAccount;

    document.addEventListener("DOMContentLoaded", () => {
        console.log("DOM fully loaded");

        // Connect Wallet
        document.getElementById("connectBtn").addEventListener("click", async () => {
            try {
                const connection = await connectWallet();
                if (!connection) return;

                userAccount = connection.userAccount;
                contract = connection.contract;

                document.getElementById("walletAddressDisplay").innerText = `Connected Wallet: ${userAccount}`;
                console.log("Wallet connected and contract initialized.");

                await loadCNSNames();
            } catch (error) {
                console.error("Error connecting wallet:", error);
            }
        });

        // Add CNS Name
        document.getElementById("addCnsBtn").addEventListener("click", async () => {
            const cnsName = document.getElementById("newCnsName").value.trim();
            if (!cnsName) {
                alert("Please enter a valid CNS name.");
                return;
            }

            try {
                console.log("Starting CNS registration...");

                // Step 1: Upload the updated metadata to IPFS
                const ipfsHash = await uploadToIPFS(userAccount, cnsName);

                // Step 2: Fetch dynamic fee
                const fee = await getDynamicFee(contract);

                // Step 3: Update the blockchain
                await updateCNSOnBlockchain(cnsName, ipfsHash, fee, userAccount, contract);

                alert(`CNS name "${cnsName}" registered successfully!`);

                await loadCNSNames();
            } catch (error) {
                console.error("Error adding CNS name:", error);
                alert("Failed to add CNS name. See console for details.");
            }
        });

        // Load CNS Names
        async function loadCNSNames() {
            const container = document.getElementById("cnsContainer");
            container.innerHTML = "Loading CNS names...";

            try {
                const metadata = await fetchUserCNS(userAccount);
                if (metadata && metadata.cnsNames) {
                    renderCNS(metadata.cnsNames, userAccount, contract, loadCNSNames);
                } else {
                    container.innerHTML = "<p>No CNS names found.</p>";
                }
            } catch (error) {
                console.error("Error loading CNS names:", error);
                container.innerHTML = "<p>Error loading CNS names. Please try again.</p>";
            }
        }

        // Add Address Handler (Make it globally available)
        window.addAddressHandler = async (cnsName, blockchain) => {
    await toggleAddress(cnsName, blockchain, userAccount, contract, loadCNSNames);
};

    });
</script>

</body>
</html>
